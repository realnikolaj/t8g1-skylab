<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>VM@Group | Hosting, deployment and infrastructure services</title><script src=https://cdn.tailwindcss.com></script><script src=https://unpkg.com/feather-icons></script><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><style type=text/tailwindcss>
    @layer base {
        body {
          @apply bg-gray-100;
          @apply font-sans;
          @apply leading-normal;
          @apply tracking-normal;
        }
        p {
          @apply py-6;
        }
        a {
          @apply text-green-500;
          @apply no-underline;
          @apply hover:underline;
        }
        h1 {
          @apply py-2;
          @apply font-sans;
          @apply text-2xl;
        }
        h2 {
          @apply py-2;
          @apply font-sans;
          @apply text-xl;
        }
        h3 {
          @apply py-2;
          @apply font-sans;
          @apply text-lg;
        }
        ol {
          @apply px-8;
          @apply list-decimal;
        }
        ul {
          @apply px-8;
          @apply list-disc;
        }
        blockquote {
          @apply border-l-4; 
          @apply border-green-500;
          @apply italic;
          @apply my-8;
          @apply pl-8;
          @apply md:pl-12;
        }
        pre {
          @apply bg-gray-900;
          @apply rounded;
          @apply text-white; 
          @apply font-mono;
          @apply text-base;
          @apply my-4;
          @apply p-2;
          @apply md:p-4;
        }
        table {
          @apply shadow-md;
          @apply rounded-lg;
          @apply m-auto;
          @apply my-8;
        }
        thead {
          @apply bg-gray-50;
        }
        th {
          @apply py-3;
          @apply px-6;
          @apply text-xs;
          @apply font-medium;
          @apply tracking-wider;
          @apply text-left;
          @apply text-gray-700;
          @apply uppercase;
        }
        tr {
          @apply bg-white;
          @apply border-b;
        }
        td {
          @apply py-4;
          @apply px-6;
          @apply text-sm;
          @apply font-medium;
          @apply text-gray-900;
          @apply whitespace-nowrap;
        }
        img {
          @apply m-auto;
          @apply object-cover;
        }
        .footer-icon {
          width: 64px; 
          height: 64px;
          @apply mx-4;
        }
      }
    </style></head><body><nav id=header class="fixed w-full z-10 top-0"><div id=progress class="h-1 z-20 top-0" style="background:linear-gradient(to right,#4dc0b5 var(--scroll),transparent 0)"></div><div class="w-full md:max-w-5xl mx-auto flex flex-wrap items-center justify-between mt-0 py-3"><div class=pl-4><a class="text-gray-900 text-base no-underline hover:no-underline font-extrabold text-xl" href=https://realnikolaj.github.io/t8g1-skylab/>Hosting, deployment and infrastructure services</a></div><div class="block lg:hidden pr-4"><button id=nav-toggle class="flex items-center px-3 py-2 border rounded text-gray-500 border-gray-600 hover:text-gray-900 hover:border-green-500 appearance-none focus:outline-none"><svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg></button></div><div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden lg:block mt-2 lg:mt-0 bg-gray-100 md:bg-transparent z-20" id=nav-content><ul class="list-reset lg:flex justify-end flex-1 items-center list-none px-0"><li><a class="inline-block py-2 px-4 text-gray-900 no-underline" href=../group-vm>Group vm</a></li><li><a class="inline-block py-2 px-4 text-gray-900 no-underline" href=../saif-vm>Saif vm</a></li><li><a class="inline-block py-2 px-4 text-gray-900 no-underline" href=../nikolaj-vm>Nikolaj vm</a></li><li><a class="inline-block py-2 px-4 text-gray-900 no-underline" href=../emin-vm>Emin vm</a></li><li><a class="inline-block py-2 px-4 text-gray-900 no-underline" href=../about>About</a></li></ul></div></div></nav><div class="container w-full md:max-w-3xl mx-auto pt-20"><div class="w-full px-4 md:px-6 text-xl text-gray-800 leading-normal" style=font-family:Georgia,serif><div class=font-sans><h1 class="font-bold font-sans break-normal text-gray-900 pt-6 pb-2 text-3xl md:text-4xl">VM@Group</h1></div><h2 id=group-vm>Group VM</h2><p><a name=id-1></a></p><hr><h3 id=1-installing-docker-and-moving-squid-into-docker>1. Installing Docker and moving squid into docker:</h3><p>Installing docker on our group vm requires carefull considerations regarding the security measure already implemented.
If a
rootless docker principle is
not established on the docker host, any container running will have root privileges which isn&rsquo;t really an issue for
veteran sysadmins that knows have to restrict access to the docker daemon using aswell firewall or custom docker
registries to allow only vetted and verified container images to run, but in the hands of non-experienced employee a
non-rootless docker client will run any code within any docker image.
The second major
concern is regarding
the iptables chains and rules applied to the group vm acting as the network&rsquo;s firewall. The group vm acts as a router
for our
internal network and routes network traffic between clients and forwards client trafic to the internet using Network
Address so that any packets originating from our clients destined to the internet will have their source headers
translated to that if the internet facing router i.e. our group host. Upon starting the docker daemon, the socket
responsible for talking to the docker client service and the containers within, new docker specific chains and rules
gets
applied to the iptables with the <code>-I</code> prefix for insertion. This is not a major concern if your aware of
this fact, but the <code>FORWARD</code> chain policy gets set to <code>DROP</code>
requiring
manual
configuration to any
docker host also acting as a router.
From docker documentation this iptables rule is supplied to help reenable ip forwarding:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell> $ iptables -I DOCKER-USER -i src_if -o dst_if -j ACCEPT
</code></pre></div><p>We&rsquo;ve opted to run the docker in root mode for a few reasons:</p><ol><li>We&rsquo;re under development and only configurations and log files could contain sensitive information about the
networks' inner workings, parameters that would resemble many other networks thus if there were to be an exploit
in our parameters we would likely be able to mitigate these before production.</li><li>Being forced to make the aforementioned critical considerations allows for a good learning environment, producing
a highly skilled, security oriented IT staff.</li><li>Docker swarm isn&rsquo;t supported under rootless docker mode.</li></ol><p>** Squid container
Using the default image registry supplied with docker, we pull and run the <code>ubuntu:squid</code> container using
this run configuration to enable host network traficking directly to the squid container:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell>$ docker run -d --name squid -p  <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>         --volume /etc/squid/squid.conf:/etc/squid/squid.conf <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>         --volume /srv/docker/squid/log:/var/log/squid <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>         --volume /srv/docker/squid/cache:/var/cache/squid <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>         -e TZ<span style=color:#f92672>=</span>Europe/Copenhagen <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>         ubuntu/squid:latest
</code></pre></div><hr><h3 id=2-pass-all-traffic-from-group-vm-through-squid-and-adjust-firewall>2. Pass all traffic from group VM through squid and adjust firewall:</h3><p><a name=id-1b></a></p><hr><h3 id=3-pro-and-cons-to-using-a-proxy-for-all-traffic>3. Pro and cons to using a proxy for all traffic:</h3><p>There are several pros and cons to using a proxy server. Security wise, a proxy server helps with protecfting a clients computer. It works like a relay between the browser and the website, since the browser doesn&rsquo;t directly speak to the website, it has to go through the proxy first. The reason for the proxy to act as a relay is if the website tries something malicious, it will hit the proxy server and not the clients computer. A proxy server can also give a faster browsing experience on the clints most used sites, since a proxy server stores a local cache. Even when managing an office or a school, can a proxy server have its uses. By running all the workers/students browsing through the proxy, an administrator can easily monitor the webtraffic, since all browsing has to go through the proxy. Not only that a proxy server can also use to block specific websites eg. malicious websites, or even social media websites, to keep your employees from entering them.<br>What is then bad about proxy servers? Well not much, but if the provider of the proxy server has malicious intent, it could cause harm for the client. As mentioned earlier, a proxy server keeps a cache for a faster browsing experience and to save bandwidth. The problem with that is it could also store private information like passwords and other details, which the provider of the proxy server can have or gain access to. For that reason it is important to have trusted provider, or create a proxy server inhouse.</p><p><a name=id-1c></a></p><hr><h3 id=4-have-a-common-folder-for-the-group-to-share-files-and-logs>4. Have a common folder for the group to share files and logs</h3><p>Firstly we create a folder for every individual on our group vm /usr/local/share with this kind of folder structure:</p><pre><code>/usr/local/share
└─── nik
│    │   files
│    │   etc...
│    └─  subfolders
│   
└─── emin
│    │   files
│    │   etc...
│    └─  subfolders
│
└─── saif
│     │   files
│     │   etc...
│     └─  subfolders
│
└─── shared
      │   saif-logs.txt
      │   emin-logs.txt
      │   nik-logs.txt
</code></pre><p>We want it so everyone can work within their own folders, and then use the share folder to share logs and other files. We want to make sure everyone only has access to their individual folder, while they all have access to the share folder. Although they should only be able to modify and delete their own files in the share folder.<br>First we want to make sure permissions are correct, and we start by adding a group, and a user for each individual. We then assign each individual to their own group and to the main group.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ groupadd t8g1-skylab
$ groupadd emin/nik/saif
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ useradd emin/nik/saif
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ usermod -a -G t8g1-skylab emin/nik/saif
$ usermod -a -G emin/nik/saif emin/nik/saif
</code></pre></div><p>After adding groups and assigning the individual users to the desired group we assign each directory to a group.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ chgrp -R emin/nik/saif /usr/local/share/<span style=color:#f92672>(</span>emin/nik/saif<span style=color:#f92672>)</span>
$ chgrp -R t8g1-skylab /usr/local/share/shared
</code></pre></div><p>After assigning each directory to a group, we can then set permissions.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ chmod g+w /usr/local/share/<span style=color:#f92672>(</span>emin/nik/saif<span style=color:#f92672>)</span>
$ chmod g+w /usr/local/share/shared
</code></pre></div><p>Now each individual has access to their own directory, and the all have access to the shared directory. Now we have to make it so only the creator of the file in the shared direcotry can modify it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>chmod +t /usr/local/share/shared
</code></pre></div><p>We then setup an nfs server and mount our individual folder and the shared folder on our individual vms. We setup the nfs server on our group vm, and make sure we give rw access, so if the user mounting the nfs is in the correct group, he or she shoud have rw access.<br>To mount the nfs filesystem we need to have the nfs client package installed.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ sudo apt install nfs-common
</code></pre></div><p>Then we mount:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ sudo mount -t nfs 192.168.165.1:/usr/local/share/<span style=color:#f92672>(</span>shared_or_emin...<span style=color:#f92672>)</span> /the_directory_we_want_to_mount_it_on_local_machine
</code></pre></div><p>We can now through our own machine access our directories and the shared directory</p><ol start=5><li></li></ol><ol start=6><li>Install a service in docker of your choosing as group which you think will need to share amongst the group,
for example authentication server, DNS server etc. Create a DMZ(a separate subnet –maybe a 10 subnet with your
group number as subnet such as t1g1 is 10.11 and t1g2 is 10.12 and so on )</li></ol><p>We&rsquo;ve opted to present a static website using Hugo and its official docker container as a service on the docker swarm.
The
service is created and attached to a
custom ingress network which is a an overlay type network exclusive for docker nodes running in swarm mode. The ingress
network and any other custom overlay networks are connected to the docker daemons physical network on each
individiul node through a virtual bridge <code>docker_gwbridge</code> enabling each node accept trafic destined for
the swarm service even when no task is running on the specific node. This relieves
the need
for for
manually
creating a subnet or DMZ zone on our dhcp
server and negates the need for manipulating the iptables in our firewall, since this is done by the docker service. A
docker swarm automatically
initializes
an overlay network called <code>ingress</code> which we reconfigured using the bellow commands:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash> $ docker network rm ingress
 $ docker network create <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --driver overlay <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --ingress <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --subnet<span style=color:#f92672>=</span>10.81.0.0/16 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --gateway<span style=color:#f92672>=</span>10.81.0.2 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --opt com.docker.network.driver.mtu<span style=color:#f92672>=</span><span style=color:#ae81ff>1200</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    t8g1-ingress
</code></pre></div><p>The ingress network, and any
overlay type
networks encrypts management trafic between the nodes rotating the AES key every 12 hours. A docker swarm
also allows for splitting management and data trafic onto separate network interfaces using the
<code>&ndash;advertise-addr</code> and <code>&ndash;datapath-addr</code> for each node when joining the swarm or at swarm
initialization.
Overlay networks such as the ingress network and any custom overlay networks acts
as a
load-balancing proxy for optimizing connections to the services within them, which a: improves loading time for
requests to services with replicas i.e. multiple, indentical and independent tasks of a single service
distributed in the swarm and b:
enables
sys-admins to create custom policies for updating services allowing rules to keep a certain amount of tasks running
at all times during the update process and thus increasing availability to the service.<br>Only custom overlay networks i.e. networks created without the parameter and option: <code>&ndash;mode ingress</code> permits
setting
the
attachable flag enabling
standalone containers to attach to
the network.
It is recommended to always create separate custom overlay networks for independent services.</p><ol start=7><li></li></ol><hr class="border-b-2 border-gray-400 mt-8 mx-4"><div class="font-sans flex justify-between content-center px-4 pb-12"><div class=text-left><p><a href=https://realnikolaj.github.io/t8g1-skylab/ class="break-normal text-base md:text-sm text-green-500 font-bold no-underline hover:underline">&lt;
Previous Page</a></p></div><div class=text-right><p><a href=../saif-vm class="break-normal text-base md:text-sm text-green-500 font-bold no-underline hover:underline">Next
Page ></a></p></div></div></div></div><footer class="bg-white border-t border-gray-400 shadow"><div class="container max-w-4xl mx-auto flex py-8"><div class="w-full mx-auto flex flex-col"><div class="flex w-full"><div class="px-8 mx-auto"><ul class="pt-3 list-none px-0 flex"><li><a class="text-gray-600 no-underline py-2" href=../explainer-notebook.html><i data-feather=file-text class=footer-icon></i></a></li><li><a class="text-gray-600 no-underline py-2" href=https://github.com/realnikolaj/t8g1-skylab><i data-feather=github class=footer-icon></i></a></li><li><a class="text-gray-600 no-underline py-2" href=https://doc.opensuse.org><i data-feather=hard-drive class=footer-icon></i></a></li></ul></div></div><div class="w-full mx-auto text-center"><ul class="list-reset items-center text-md py-6 list-none flex"><li class=mx-auto><p class="inline-block text-gray-600 mx-4 font-semibold capitalized">Nikolaj S. Povlsen, Saif Ali, Emin Olcer</p></li></ul></div></div></div></footer><script>var h=document.documentElement,b=document.body,st='scrollTop',sh='scrollHeight',progress=document.querySelector('#progress'),scrollpos=window.scrollY,header=document.getElementById("header"),navcontent=document.getElementById("nav-content"),scroll;document.addEventListener('scroll',function(){scroll=(h[st]||b[st])/((h[sh]||b[sh])-h.clientHeight)*100,progress.style.setProperty('--scroll',scroll+'%'),scrollpos=window.scrollY,scrollpos>10?(header.classList.add("bg-white"),header.classList.add("shadow"),navcontent.classList.remove("bg-gray-100"),navcontent.classList.add("bg-white")):(header.classList.remove("bg-white"),header.classList.remove("shadow"),navcontent.classList.remove("bg-white"),navcontent.classList.add("bg-gray-100"))}),document.getElementById('nav-toggle').onclick=function(){document.getElementById("nav-content").classList.toggle("hidden")},feather.replace()</script></body></html>